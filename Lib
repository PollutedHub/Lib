local Library = {}
Library.__index = Library

-- Services
local TweenService = game:GetService("TweenService")
local RunService   = game:GetService("RunService")
local Players      = game:GetService("Players")
local UserInput    = game:GetService("UserInputService")

-- ======= Utilities =======
local function new(class, props)
    local inst = Instance.new(class)
    if props then
        for k, v in pairs(props) do
            if k == "Parent" then inst.Parent = v else inst[k] = v end
        end
    end
    return inst
end

local function twn(inst, props, time)
    time = time or 0.18
    local ti = TweenInfo.new(time, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local ok, t = pcall(function() return TweenService:Create(inst, ti, props) end)
    if ok and t then t:Play() end
end

local function isExecutorEnv()
    -- rough detection: presence of writefile or syn
    return type(writefile) == "function" or type(syn) == "table"
end

local function safeParent()
    -- prefer CoreGui if accessible (executors)
    local ok, core = pcall(function() return game:GetService("CoreGui") end)
    if ok and core and (RunService:IsStudio() or core) then
        return core
    end
    local plr = Players.LocalPlayer
    if plr then
        local ok2, pg = pcall(function() return plr:FindFirstChild("PlayerGui") end)
        if ok2 and pg then return pg end
    end
    return game:GetService("CoreGui")
end

local function clamp(v, a, b)
    if v < a then return a end
    if v > b then return b end
    return v
end

local function isWithin(vec2, frame)
    local absPos = frame.AbsolutePosition
    local size = frame.AbsoluteSize
    return vec2.X >= absPos.X and vec2.X <= absPos.X + size.X and vec2.Y >= absPos.Y and vec2.Y <= absPos.Y + size.Y
end

-- ======= Theme =======
local DefaultTheme = {
    Background = Color3.fromHex and Color3.fromHex("#0f1115") or Color3.fromRGB(15,17,21),
    Panel      = Color3.fromHex and Color3.fromHex("#14151a") or Color3.fromRGB(20,21,26),
    Accent     = Color3.fromHex and Color3.fromHex("#5ee3b9") or Color3.fromRGB(94,227,185),
    Text       = Color3.fromHex and Color3.fromHex("#dbe6ef") or Color3.fromRGB(219,230,239),
    Subtext    = Color3.fromHex and Color3.fromHex("#9aa6b2") or Color3.fromRGB(154,166,178),
    Glow       = Color3.fromHex and Color3.fromHex("#0f6b5a") or Color3.fromRGB(15,107,90)
}

local Theme = {}
Theme.current = {}
for k,v in pairs(DefaultTheme) do Theme.current[k] = v end

function Theme:Set(tbl)
    for k,v in pairs(tbl) do Theme.current[k] = v end
    -- optionally: update live UI - we will call a callback if present
    if Library._onThemeChanged then
        pcall(Library._onThemeChanged, Theme.current)
    end
end

function Theme:Get() return Theme.current end

Library.Theme = Theme

-- ======= Save Manager =======
local Save = {}
local saveFolder = "ObsidianLite_Saves"
local function safeWrite(path, data)
    if type(writefile) == "function" then
        writefile(path, data)
        return true
    elseif isfile and writefile and isfile then
        -- some envs use isfile/writefile - covered above
        writefile(path, data)
        return true
    end
    return false
end
local function safeRead(path)
    if type(readfile) == "function" then
        return readfile(path)
    end
    return nil
end
local function safeExists(path)
    if type(isfile) == "function" then
        return isfile(path)
    end
    return false
end

Save._mem = {} -- fallback memory store
function Save:Set(name, tbl)
    local ok, json
    if type(game.HttpService) == "table" then
        json = game:GetService("HttpService"):JSONEncode(tbl)
    else
        json = tostring(tbl)
    end
    local filename = saveFolder .. "/" .. name .. ".json"
    local wrote = pcall(function() return safeWrite(filename, json) end)
    if not wrote then
        Save._mem[name] = tbl
    end
end

function Save:Get(name)
    local filename = saveFolder .. "/" .. name .. ".json"
    local readok, content = pcall(function() return safeRead(filename) end)
    if readok and content then
        local ok, decoded = pcall(function() return game:GetService("HttpService"):JSONDecode(content) end)
        if ok then return decoded end
    end
    return Save._mem[name]
end

function Save:Exists(name)
    local filename = saveFolder .. "/" .. name .. ".json"
    return pcall(function() return safeExists(filename) end) and safeExists(filename) or Save._mem[name] ~= nil
end

Library.Save = Save

-- ======= Notification Manager =======
local Notif = {}
Notif.queue = {}
Notif._root = nil

function Notif:_makeRoot(parent)
    if self._root and self._root.Parent then return self._root end
    local root = new("ScreenGui", {Name = "ObsidianNotify", Parent = parent, ResetOnSpawn = false})
    local frame = new("Frame", {Parent = root, Size = UDim2.new(0,280,0,120), Position = UDim2.new(1,-300,0,20), BackgroundTransparency = 1})
    frame.ZIndex = 9999
    local layout = new("UIListLayout", {Parent = frame, VerticalAlignment = Enum.VerticalAlignment.Top, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0,8)})
    self._root = frame
    return frame
end

function Notif:Notify(title, text, seconds)
    local parent = Library.ScreenGui and Library.ScreenGui.Parent or safeParent()
    local root = self:_makeRoot(parent)
    local item = new("Frame", {Parent = root, Size = UDim2.new(1,0,0,64), BackgroundColor3 = Theme.current.Panel, BorderSizePixel = 0})
    item.ClipsDescendants = true
    new("UICorner", {Parent = item, CornerRadius = UDim.new(0,8)})
    local ttl = new("TextLabel", {Parent = item, Text = title, Size = UDim2.new(1,-12,0,20), Position = UDim2.new(0,6,0,6), BackgroundTransparency = 1, TextColor3 = Theme.current.Text, Font = Enum.Font.SourceSansSemibold, TextSize = 14, TextXAlignment = Enum.TextXAlignment.Left})
    local body = new("TextLabel", {Parent = item, Text = text, Size = UDim2.new(1,-12,0,36), Position = UDim2.new(0,6,0,24), BackgroundTransparency = 1, TextColor3 = Theme.current.Subtext, Font = Enum.Font.SourceSans, TextSize = 13, TextXAlignment = Enum.TextXAlignment.Left, TextYAlignment = Enum.TextYAlignment.Top})
    item.Position = UDim2.new(1, -280, 0, 20)
    item.BackgroundTransparency = 0
    twn(item, {Position = UDim2.new(1, -300, 0, 20)}, 0.22)
    local dur = seconds or 4
    delay(dur, function()
        pcall(function() twn(item, {Position = UDim2.new(1, -280, 0, 20)}, 0.22) end)
        wait(0.18)
        pcall(function() item:Destroy() end)
    end)
end

Library.Notify = function(title, text, seconds) Notif:Notify(title, text, seconds) end

-- ======= Core UI creation =======
function Library:Init(opts)
    opts = opts or {}
    local parent = opts.Parent or safeParent()
    local sgName = opts.Name or ("ObsidianLib_" .. tostring(math.random(1000,9999)))
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = sgName
    screenGui.ResetOnSpawn = false
    screenGui.Parent = parent
    self.ScreenGui = screenGui
    self.Parent = parent
    return screenGui
end

-- Auto-init on load
Library:Init({})

-- Keep track of windows for theme updates
Library._windows = {}

-- helper: draggable
local function makeDraggable(frame, handle)
    handle.Active = true
    handle.Selectable = true
    handle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            local startPos = input.Position
            local startFrame = frame.Position
            local conn
            conn = UserInput.InputChanged:Connect(function(move)
                if move.UserInputType == Enum.UserInputType.MouseMovement then
                    local delta = move.Position - startPos
                    local nx = startFrame + UDim2.new(0, delta.X, 0, delta.Y)
                    frame.Position = nx
                end
            end)
            local upConn
            upConn = UserInput.InputEnded:Connect(function(ended)
                if ended.UserInputType == Enum.UserInputType.MouseButton1 then
                    conn:Disconnect()
                    upConn:Disconnect()
                end
            end)
        end
    end)
end

-- ======= Window creation =======
function Library:CreateWindow(title, opts)
    opts = opts or {}
    local size = opts.Size or UDim2.new(0, 560, 0, 380)
    local pos  = opts.Position or UDim2.new(0.5, -size.X.Offset/2, 0.35, -size.Y.Offset/2)

    -- root frame
    local frame = new("Frame", {
        Parent = self.ScreenGui,
        Size = size,
        Position = pos,
        AnchorPoint = Vector2.new(0.5,0.5),
        BackgroundColor3 = Theme.current.Panel,
        BorderSizePixel = 0,
        ZIndex = 50,
    })
    new("UICorner", {Parent = frame, CornerRadius = UDim.new(0,10)})
    frame.ClipsDescendants = true

    -- header
    local header = new("Frame", {Parent = frame, Size = UDim2.new(1,0,0,36), BackgroundTransparency = 1})
    local titleLabel = new("TextLabel", {Parent = header, Text = title or "Window", Size = UDim2.new(1, -40, 1, 0), Position = UDim2.new(0, 12, 0, 0), BackgroundTransparency = 1, Font = Enum.Font.SourceSansSemibold, TextSize = 16, TextColor3 = Theme.current.Text, TextXAlignment = Enum.TextXAlignment.Left})
    local closeBtn = new("TextButton", {Parent = header, Size = UDim2.new(0,28,0,20), Position = UDim2.new(1,-36,0,8), BackgroundColor3 = Theme.current.Background, BorderSizePixel = 0, Text = "Ã—", Font = Enum.Font.SourceSansBold, TextSize = 18, TextColor3 = Theme.current.Text})
    new("UICorner", {Parent = closeBtn, CornerRadius = UDim.new(0,6)})
    closeBtn.MouseButton1Click:Connect(function() frame:Destroy() end)

    -- body layout (left tabs + right content)
    local body = new("Frame", {Parent = frame, Size = UDim2.new(1,0,1,-36), Position = UDim2.new(0,0,0,36), BackgroundTransparency = 1})
    local left = new("Frame", {Parent = body, Size = UDim2.new(0,160,1,0), BackgroundTransparency = 1})
    local leftPad = new("UIPadding", {Parent = left, PaddingTop = UDim.new(0,8), PaddingLeft = UDim.new(0,8), PaddingRight = UDim.new(0,8)})
    local leftLayout = new("UIListLayout", {Parent = left, Padding = UDim.new(0,8), SortOrder = Enum.SortOrder.LayoutOrder})
    leftLayout.HorizontalAlignment = Enum.HorizontalAlignment.Left

    local right = new("Frame", {Parent = body, Size = UDim2.new(1, -170, 1, 0), Position = UDim2.new(0,170,0,0), BackgroundTransparency = 1})
    local pagePadding = new("UIPadding", {Parent = right, PaddingTop = UDim.new(0,8), PaddingLeft = UDim.new(0,10), PaddingRight = UDim.new(0,10)})

    local tabs = {}
    local pages = {}

    local function selectTab(index)
        for i,p in ipairs(pages) do
            p.Visible = (i == index)
        end
        for i,t in ipairs(tabs) do
            t.Button.BackgroundColor3 = (i == index) and Theme.current.Panel or Theme.current.Background
            t.Button.TextColor3 = Theme.current.Text
        end
    end

    -- API for window
    local windowAPI = {}
    function windowAPI:CreateTab(name)
        local index = #tabs + 1
        -- tab button
        local btn = new("TextButton", {Parent = left, Text = name, Size = UDim2.new(1, -8, 0, 34), BackgroundColor3 = Theme.current.Background, BorderSizePixel = 0, Font = Enum.Font.SourceSans, TextSize = 14, TextColor3 = Theme.current.Text, AutoButtonColor = false})
        new("UICorner", {Parent = btn, CornerRadius = UDim.new(0,8)})
        -- content page
        local page = new("Frame", {Parent = right, Size = UDim2.new(1,0,1,0), BackgroundTransparency = 1, Visible = false})
        local pageList = new("UIListLayout", {Parent = page, Padding = UDim.new(0,8), SortOrder = Enum.SortOrder.LayoutOrder})
        pageList.HorizontalAlignment = Enum.HorizontalAlignment.Left
        pages[index] = page
        tabs[index] = {Button = btn, Page = page}

        -- select first automatically
        if #tabs == 1 then
            selectTab(1)
        end

        btn.MouseButton1Click:Connect(function() selectTab(index) end)

        -- Tab object
        local tabObj = {}

        function tabObj:CreateToggle(label, default, callback)
            default = default == true
            local cont = new("Frame", {Parent = page, Size = UDim2.new(1, -10, 0, 36), BackgroundTransparency = 1})
            local lbl = new("TextLabel", {Parent = cont, Text = label, Size = UDim2.new(1, -90, 1, 0), BackgroundTransparency = 1, TextColor3 = Theme.current.Text, Font = Enum.Font.SourceSans, TextSize = 14, TextXAlignment = Enum.TextXAlignment.Left})
            local btn = new("TextButton", {Parent = cont, Size = UDim2.new(0,70,0,26), Position = UDim2.new(1, -78, 0, 5), BackgroundColor3 = Theme.current.Background, BorderSizePixel = 0, AutoButtonColor = false, Text = ""})
            new("UICorner", {Parent = btn, CornerRadius = UDim.new(0,6)})
            local knob = new("Frame", {Parent = btn, Size = UDim2.new(0.48, -6, 1, -6), Position = default and UDim2.new(1, - (math.floor((70-6)/2)), 0, 3) or UDim2.new(0, 6, 0, 3), BackgroundColor3 = default and Theme.current.Accent or Color3.fromRGB(55,55,55)})
            new("UICorner", {Parent = knob, CornerRadius = UDim.new(0,6)})
            local state = default

            local function setState(v, noCb)
                state = v
                if state then
                    twn(knob, {Position = UDim2.new(1, - (math.floor((70-6)/2)), 0, 3)}, 0.14)
                    knob.BackgroundColor3 = Theme.current.Accent
                else
                    twn(knob, {Position = UDim2.new(0, 6, 0, 3)}, 0.14)
                    knob.BackgroundColor3 = Color3.fromRGB(55,55,55)
                end
                if callback and not noCb then
                    pcall(callback, state)
                end
            end

            btn.MouseButton1Click:Connect(function() setState(not state) end)
            if callback then pcall(callback, state) end

            return { Set = setState, Get = function() return state end }
        end

        function tabObj:CreateDropdown(label, options, defaultIndex, callback)
            options = options or {}
            defaultIndex = defaultIndex or 1
            local cont = new("Frame", {Parent = page, Size = UDim2.new(1, -10, 0, 38), BackgroundTransparency = 1})
            local lbl = new("TextLabel",{Parent = cont, Text = label, Size = UDim2.new(1, -150, 1, 0), BackgroundTransparency = 1, TextColor3 = Theme.current.Text, Font = Enum.Font.SourceSans, TextSize = 14, TextXAlignment = Enum.TextXAlignment.Left})
            local btn = new("TextButton", {Parent = cont, Size = UDim2.new(0,140,0,26), Position = UDim2.new(1, -148, 0, 6), BackgroundColor3 = Theme.current.Background, BorderSizePixel = 0, Text = tostring(options[defaultIndex] or "Select"), Font = Enum.Font.SourceSans, TextSize = 14, TextColor3 = Theme.current.Text})
            new("UICorner", {Parent = btn, CornerRadius = UDim.new(0,6)})
            local list = new("Frame", {Parent = cont, Size = UDim2.new(0,140,0, math.max(1,#options) * 28), Position = UDim2.new(1, -148, 0, 40), BackgroundColor3 = Theme.current.Panel, Visible = false})
            list.ClipsDescendants = true
            new("UICorner", {Parent = list, CornerRadius = UDim.new(0,6)})
            local listLayout = new("UIListLayout", {Parent = list, Padding = UDim.new(0,4)})

            for i,opt in ipairs(options) do
                local it = new("TextButton", {Parent = list, Text = tostring(opt), Size = UDim2.new(1,0,0,24), BackgroundTransparency = 1, BorderSizePixel = 0, Font = Enum.Font.SourceSans, TextSize = 14, TextColor3 = Theme.current.Text})
                it.MouseButton1Click:Connect(function()
                    btn.Text = tostring(opt)
                    list.Visible = false
                    if callback then pcall(callback, opt, i) end
                end)
            end

            btn.MouseButton1Click:Connect(function() list.Visible = not list.Visible end)
            if options[defaultIndex] and callback then pcall(callback, options[defaultIndex], defaultIndex) end

            return {
                Set = function(v)
                    if type(v) == "number" then
                        btn.Text = tostring(options[v] or btn.Text)
                    else
                        btn.Text = tostring(v)
                    end
                end,
                Get = function() return btn.Text end
            }
        end

        function tabObj:CreateSlider(label, min, max, default, step, callback)
            min = tonumber(min) or 0
            max = tonumber(max) or 100
            default = tonumber(default) or min
            step = tonumber(step) or 1
            local cont = new("Frame", {Parent = page, Size = UDim2.new(1, -10, 0, 48), BackgroundTransparency = 1})
            local lbl = new("TextLabel", {Parent = cont, Text = label, Size = UDim2.new(1, -110, 0, 20), BackgroundTransparency = 1, TextColor3 = Theme.current.Text, Font = Enum.Font.SourceSans, TextSize = 14, TextXAlignment = Enum.TextXAlignment.Left})
            local valLabel = new("TextLabel", {Parent = cont, Text = tostring(default), Size = UDim2.new(0,90,0,20), Position = UDim2.new(1,-100,0,0), BackgroundTransparency = 1, TextColor3 = Theme.current.Subtext, Font = Enum.Font.SourceSans, TextSize = 13, TextXAlignment = Enum.TextXAlignment.Right})
            local bar = new("Frame", {Parent = cont, Size = UDim2.new(1, -10, 0, 10), Position = UDim2.new(0,6,0,28), BackgroundColor3 = Theme.current.Background, BorderSizePixel = 0})
            new("UICorner", {Parent = bar, CornerRadius = UDim.new(0,6)})
            local fill = new("Frame", {Parent = bar, Size = UDim2.new((default - min) / (max - min), 0, 1, 0), BackgroundColor3 = Theme.current.Accent, BorderSizePixel = 0})
            new("UICorner", {Parent = fill, CornerRadius = UDim.new(0,6)})

            local dragging = false
            bar.InputBegan:Connect(function(inp)
                if inp.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = true
                end
            end)
            UserInput.InputEnded:Connect(function(inp)
                if inp.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
            end)
            UserInput.InputChanged:Connect(function(inp)
                if dragging and inp.UserInputType == Enum.UserInputType.MouseMovement then
                    local abs = bar.AbsolutePosition
                    local size = bar.AbsoluteSize
                    local x = clamp((UserInput:GetMouseLocation().X - abs.X) / size.X, 0, 1)
                    local v = math.floor(((min + (max - min) * x) / step) + 0.5) * step
                    v = clamp(v, min, max)
                    fill.Size = UDim2.new((v - min) / (max - min), 0, 1, 0)
                    valLabel.Text = tostring(v)
                    if callback then pcall(callback, v) end
                end
            end)

            if callback then pcall(callback, default) end
            return { Set = function(v) v = clamp(v, min, max); fill.Size = UDim2.new((v - min)/(max - min),0,1,0); valLabel.Text = tostring(v); if callback then pcall(callback, v) end end }
        end

        function tabObj:CreateButton(label, callback)
            local cont = new("Frame", {Parent = page, Size = UDim2.new(1, -10, 0, 36), BackgroundTransparency = 1})
            local btn = new("TextButton", {Parent = cont, Size = UDim2.new(0,160,0,30), Position = UDim2.new(0,6,0,3), BackgroundColor3 = Theme.current.Accent, BorderSizePixel = 0, Text = label or "Button", Font = Enum.Font.SourceSansSemibold, TextSize = 14, TextColor3 = Theme.current.Text})
            new("UICorner", {Parent = btn, CornerRadius = UDim.new(0,8)})
            btn.MouseButton1Click:Connect(function() if callback then pcall(callback) end end)
            return btn
        end

        function tabObj:CreateKeybind(label, defaultKey, callback)
            local cont = new("Frame", {Parent = page, Size = UDim2.new(1, -10, 0, 36), BackgroundTransparency = 1})
            local lbl = new("TextLabel", {Parent = cont, Text = label, Size = UDim2.new(1, -160, 1, 0), BackgroundTransparency = 1, TextColor3 = Theme.current.Text, Font = Enum.Font.SourceSans, TextSize = 14, TextXAlignment = Enum.TextXAlignment.Left})
            local box = new("TextButton", {Parent = cont, Size = UDim2.new(0,140,0,26), Position = UDim2.new(1, -148, 0, 5), Text = defaultKey.Name or tostring(defaultKey), BackgroundColor3 = Theme.current.Background, BorderSizePixel = 0, Font = Enum.Font.SourceSans, TextSize = 14, TextColor3 = Theme.current.Text})
            new("UICorner", {Parent = box, CornerRadius = UDim.new(0,6)})

            local listening = false
            local boundEnum = defaultKey

            box.MouseButton1Click:Connect(function()
                box.Text = "Press a key..."
                listening = true
            end)

            local conn
            conn = UserInput.InputBegan:Connect(function(inp, gpe)
                if listening and not gpe then
                    if inp.UserInputType == Enum.UserInputType.Keyboard then
                        boundEnum = inp.KeyCode
                        box.Text = boundEnum.Name
                        listening = false
                        if callback then pcall(callback, boundEnum) end
                    end
                end
            end)
            return {
                Set = function(kc) boundEnum = kc; box.Text = kc.Name end,
                Get = function() return boundEnum end,
                Disconnect = function() if conn then conn:Disconnect() end end
            }
        end

        return tabObj
    end

    -- Make header draggable
    makeDraggable(frame, titleLabel)

    local api = {
        Root = frame,
        CreateTab = function(_, name) return windowAPI:CreateTab(name) end,
        Show = function() frame.Visible = true end,
        Hide = function() frame.Visible = false end,
        Destroy = function() frame:Destroy() end,
    }
    table.insert(self._windows, api)
    -- theme update hook
    Library._onThemeChanged = function(theme)
        -- update main frame colors (best effort)
        if frame and frame.Parent then
            frame.BackgroundColor3 = theme.Panel or frame.BackgroundColor3
            titleLabel.TextColor3 = theme.Text or titleLabel.TextColor3
            closeBtn.BackgroundColor3 = theme.Background or closeBtn.BackgroundColor3
            closeBtn.TextColor3 = theme.Text or closeBtn.TextColor3
        end
    end
    return api
end

-- Return Library as a callable initializer
local function InitReturn()
    return setmetatable(Library, { __call = function(_, ...)
        return Library
    end })
end

-- expose simple Notify and Save interfaces
Library.Notify = Library.Notify
Library.Save = Library.Save
Library.Theme = Theme

return InitReturn()
